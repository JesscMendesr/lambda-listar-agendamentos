name: üöÄ Deploy Lambda

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  LAMBDA_NAME: "lambda-listar-agendamentos"  # ‚ö†Ô∏è ALTERE PARA SUA LAMBDA
  AWS_REGION: "us-east-2"

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        
      - name: üîç Verificar estrutura
        run: |
          echo "üìÅ Estrutura do reposit√≥rio:"
          ls -la
          echo ""
          echo "üîç Procurando arquivos Lambda..."
          find . -name "*.mjs" -o -name "*.js" | grep -v node_modules || echo "Nenhum arquivo encontrado"

      - name: üì¶ Criar pacote (FIXED)
        id: package
        run: |
          echo "üîé Detectando arquivo principal..."
          
          # Procura o arquivo principal
          if [ -f "index.mjs" ]; then
            CODE_FILE="index.mjs"
            echo "‚úÖ Usando: index.mjs (ES Modules)"
          elif [ -f "index.js" ]; then
            CODE_FILE="index.js"
            echo "‚úÖ Usando: index.js (CommonJS)"
          elif [ -f "handler.mjs" ]; then
            CODE_FILE="handler.mjs"
            echo "‚úÖ Usando: handler.mjs"
          elif [ -f "handler.js" ]; then
            CODE_FILE="handler.js"
            echo "‚úÖ Usando: handler.js"
          else
            echo "‚ùå ERRO: Nenhum arquivo Lambda encontrado!"
            echo "üìÅ Arquivos no diret√≥rio:"
            ls -la
            exit 1
          fi
          
          echo "üóúÔ∏è Criando package: $CODE_FILE"
          
          # Cria o ZIP
          zip lambda-package.zip "$CODE_FILE"
          
          # Verifica se criou
          if [ ! -f "lambda-package.zip" ]; then
            echo "‚ùå ERRO: Falha ao criar ZIP!"
            exit 1
          fi
          
          echo "‚úÖ Package criado com sucesso!"
          echo "üìä Tamanho: $(stat -f%z lambda-package.zip) bytes"
          echo ""
          echo "üì¶ Conte√∫do do ZIP:"
          unzip -l lambda-package.zip
          
          # Salva o nome do arquivo para uso posterior
          echo "code_file=$CODE_FILE" >> $GITHUB_OUTPUT

      - name: üîê Configurar AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ‚úÖ Verificar Lambda
        run: |
          echo "üîç Verificando Lambda: ${{ env.LAMBDA_NAME }}"
          
          # Tenta obter info da Lambda
          if aws lambda get-function \
            --function-name "${{ env.LAMBDA_NAME }}" \
            --region "${{ env.AWS_REGION }}" 2>/dev/null; then
            echo "‚úÖ Lambda encontrada!"
          else
            echo "‚ö†Ô∏è AVISO: Lambda n√£o encontrada"
            echo "Se for a primeira vez, crie manualmente:"
            echo "- Runtime: Node.js 20.x"
            echo "- Handler: index.handler"
            echo "- Timeout: 30s, Memory: 128MB"
          fi

      - name: üöÄ Fazer Deploy
        run: |
          echo "üöÄ Fazendo deploy para: ${{ env.LAMBDA_NAME }}"
          
          # Comando de deploy
          aws lambda update-function-code \
            --function-name "${{ env.LAMBDA_NAME }}" \
            --zip-file fileb://lambda-package.zip \
            --region "${{ env.AWS_REGION }}" \
            --no-cli-pager
          
          echo "‚úÖ Deploy conclu√≠do!"
          
          # Verifica √∫ltima modifica√ß√£o
          echo "üïí √öltima atualiza√ß√£o:"
          aws lambda get-function \
            --function-name "${{ env.LAMBDA_NAME }}" \
            --query 'Configuration.LastModified' \
            --region "${{ env.AWS_REGION }}" \
            --output text

      - name: üß™ Teste r√°pido
        run: |
          echo "üß™ Testando Lambda (aguardando 10s)..."
          sleep 10
          
          # Teste simples
          if aws lambda invoke \
            --function-name "${{ env.LAMBDA_NAME }}" \
            --payload '{}' \
            --cli-binary-format raw-in-base64-out \
            --region "${{ env.AWS_REGION }}" \
            test-output.json 2>/dev/null; then
            
            echo "‚úÖ Lambda executada com sucesso!"
            echo "üìÑ Sa√≠da:"
            cat test-output.json || echo "(vazio)"
            rm -f test-output.json
          else
            echo "‚ö†Ô∏è Teste falhou (pode ser normal para algumas Lambdas)"
          fi

      - name: üéâ Concluir
        if: success()
        run: |
          echo ""
          echo "========================================"
          echo "üéâ DEPLOY CONCLU√çDO COM SUCESSO!"
          echo "========================================"
          echo "Lambda: ${{ env.LAMBDA_NAME }}"
          echo "Reposit√≥rio: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "========================================"